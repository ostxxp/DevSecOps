# Альтернативные решения проблемы с базой данных Dependency Check

## Проблема
Dependency Check не может обновить базу данных из-за ошибки блокировки H2: "Unable to obtain an exclusive lock on the H2 database to perform updates"

## Альтернативные решения

### Решение 1: Использовать готовую базу данных из публичного источника

**Идея:** Скачать готовую базу данных, которая уже обновлена кем-то другим.

```yaml
- name: Download Pre-populated Database
  run: |
    mkdir -p ~/.dependency-check/data
    # Скачиваем готовую базу данных (если доступна)
    # ВАЖНО: Это требует наличия публичного источника готовой базы
    wget -q https://example.com/dependency-check-db.tar.gz -O /tmp/db.tar.gz
    tar -xzf /tmp/db.tar.gz -C ~/.dependency-check/data
```

**Плюсы:** Быстро, не требует обновления  
**Минусы:** Нужен публичный источник готовой базы данных

---

### Решение 2: Использовать альтернативный инструмент SCA

**Идея:** Использовать другой инструмент для SCA, который не требует локальной базы данных.

#### Вариант A: Snyk (облачный сервис)
```yaml
- name: Run Snyk Scan
  uses: snyk/actions/node@master
  env:
    SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
  with:
    args: --severity-threshold=high
```

#### Вариант B: GitHub Dependabot (встроенный)
```yaml
# .github/dependabot.yml
version: 2
updates:
  - package-ecosystem: "composer"
    directory: "/app"
    schedule:
      interval: "weekly"
```

#### Вариант C: OWASP Dependency-Track (отдельный сервер)
- Требует отдельный сервер
- База данных на сервере, не локально

**Плюсы:** Не требует локальной базы данных  
**Минусы:** Нужна настройка альтернативного инструмента

---

### Решение 3: Использовать готовый Docker образ с предустановленной базой

**Идея:** Использовать Docker образ, который уже содержит обновленную базу данных.

```yaml
- name: Use Pre-populated Docker Image
  run: |
    # Используем образ с предустановленной базой
    docker run --rm \
      -v "$PWD:/src" \
      -v "$PWD/reports:/report" \
      custom-dependency-check:with-db \
      --scan /src/app \
      --format HTML \
      --format JSON \
      --out /report \
      --project "DVWA" \
      --noupdate
```

**Плюсы:** База уже есть в образе  
**Минусы:** Нужно создать собственный Docker образ

---

### Решение 4: Обновлять базу данных локально и загружать в кэш

**Идея:** Обновить базу данных на локальной машине, затем загрузить в GitHub Actions кэш.

**Шаги:**
1. Локально: `dependency-check.sh --updateonly`
2. Архивировать: `tar -czf db.tar.gz ~/.dependency-check/data`
3. Загрузить в GitHub Releases или другой хранилище
4. В workflow: скачать и распаковать

```yaml
- name: Download Pre-updated Database
  run: |
    mkdir -p ~/.dependency-check/data
    wget -q https://github.com/your-repo/releases/download/db/dependency-check-db.tar.gz
    tar -xzf dependency-check-db.tar.gz -C ~/.dependency-check/data
```

**Плюсы:** Полный контроль над базой данных  
**Минусы:** Требует ручного обновления

---

### Решение 5: Использовать GitHub Actions с предустановленной базой

**Идея:** Создать отдельный workflow, который обновляет базу данных раз в неделю и сохраняет в кэш.

```yaml
# .github/workflows/update-db.yml
name: Update Dependency Check Database
on:
  schedule:
    - cron: '0 0 * * 0'  # Каждое воскресенье
  workflow_dispatch:

jobs:
  update-db:
    runs-on: ubuntu-latest
    steps:
      - name: Update Database
        run: |
          # Обновление базы данных
          # Сохранение в кэш
```

**Плюсы:** Автоматическое обновление  
**Минусы:** Все равно может быть проблема с блокировкой

---

### Решение 6: Использовать другой формат базы данных

**Идея:** Dependency Check поддерживает разные форматы базы данных. Можно попробовать использовать SQLite вместо H2.

**Проблема:** Dependency Check по умолчанию использует H2, и это не настраивается легко.

---

### Решение 7: Использовать сканирование БЕЗ базы данных (текущее решение)

**Идея:** Запускать сканирование с `--noupdate`, даже если база пустая. Отчёты будут сгенерированы, но без данных об уязвимостях.

**Плюсы:** Работает сразу, нет ошибок  
**Минусы:** Нет данных об уязвимостях в отчётах

---

## Рекомендация для вашего случая

**Для финального проекта рекомендую:**

1. **Использовать текущее решение** (сканирование без обновления базы)
   - Работает без ошибок
   - Генерирует отчёты
   - Можно описать в отчёте как "настройка инструмента выполнена"

2. **В отчёте описать:**
   - Инструмент настроен и интегрирован
   - Проблема с обновлением базы данных (известная проблема)
   - Решение: использование кэширования и сканирования без обновления
   - Для полной функциональности требуется обновление базы данных

3. **Альтернатива:** Если нужны реальные данные об уязвимостях:
   - Обновить базу данных локально
   - Загрузить в GitHub Releases
   - Скачать в workflow

---

## Быстрое решение: Локальное обновление + загрузка

Если у вас есть доступ к локальной машине:

```bash
# 1. Локально обновить базу данных
dependency-check.sh --updateonly

# 2. Архивировать базу данных
cd ~/.dependency-check
tar -czf dependency-check-db.tar.gz data/

# 3. Загрузить в GitHub Releases или другой хранилище
# 4. В workflow скачать и распаковать
```

Это самое надёжное решение для получения полных отчётов с данными об уязвимостях.

