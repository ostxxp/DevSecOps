name: Security Scan

on: [push, pull_request]

jobs:
  sonarqube:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: SonarQube Scan
        uses: SonarSource/sonarqube-scan-action@v4
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  dependency-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Cache Dependency Check Database
        uses: actions/cache@v3
        with:
          path: ~/.dependency-check/data
          key: dependency-check-db-${{ runner.os }}-${{ hashFiles('**/composer.lock', '**/package-lock.json') }}
          restore-keys: |
            dependency-check-db-${{ runner.os }}-

      - name: Download and Install OWASP Dependency Check
        run: |
          echo "üì¶ Downloading OWASP Dependency Check..."
          # –°–∫–∞—á–∏–≤–∞–µ–º –≤–µ—Ä—Å–∏—é 10.0.0
          wget -q https://github.com/jeremylong/DependencyCheck/releases/download/v10.0.0/dependency-check-10.0.0-release.zip
          unzip -q dependency-check-10.0.0-release.zip -d dependency-check
          chmod +x dependency-check/dependency-check/bin/dependency-check.sh
          
          echo "‚úÖ Dependency Check installed"
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–µ—Ä—Å–∏—é –∏ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –∞—Ä–≥—É–º–µ–Ω—Ç—ã
          ./dependency-check/dependency-check/bin/dependency-check.sh --version

      - name: Run Dependency Check Scan
        run: |
          echo "üîç Starting Dependency Check scan..."
          
          # –°–æ–∑–¥–∞–µ–º –ø–∞–ø–∫—É –¥–ª—è –æ—Ç—á–µ—Ç–æ–≤
          mkdir -p reports
          
          # –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –ö–û–ú–ê–ù–î–ê: —É–±—Ä–∞–Ω—ã –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∞—Ä–≥—É–º–µ–Ω—Ç—ã
          ./dependency-check/dependency-check/bin/dependency-check.sh \
            --project "DVWA Security Scan" \
            --scan ./app \
            --format HTML \
            --format JSON \
            --out ./reports \
            --disableNodeAudit \
            --disableNodeJS \
            --disableRetireJS \
            --disableOssIndex \
            --nvdApiDelay 6000 \
            --nvdMaxRetryCount 10 \
            --failOnCVSS 0
          
          echo "‚úÖ Scan completed!"

      - name: Check Generated Reports
        run: |
          echo "üìä Checking generated reports..."
          if [ -f "reports/dependency-check-report.html" ]; then
            echo "‚úÖ HTML report generated: $(ls -lh reports/dependency-check-report.html)"
            echo "--- Report Summary ---"
            # –ò–∑–≤–ª–µ–∫–∞–µ–º –∫–ª—é—á–µ–≤—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–∑ HTML-–æ—Ç—á–µ—Ç–∞
            grep -i "vulnerabilities\|dependencies" reports/dependency-check-report.html | head -5
          else
            echo "‚ùå HTML report not found"
          fi
          
          if [ -f "reports/dependency-check-report.json" ]; then
            echo "‚úÖ JSON report generated: $(ls -lh reports/dependency-check-report.json)"
            echo "--- JSON Summary ---"
            # –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ JSON
            python3 -c "import json, os; data = json.load(open('reports/dependency-check-report.json')) if os.path.exists('reports/dependency-check-report.json') else {}; deps = len(data.get('dependencies', [])); vulns = sum(len(d.get('vulnerabilities', [])) for d in data.get('dependencies', [])); print(f'Scanned Dependencies: {deps}'); print(f'Total Vulnerabilities Found: {vulns}'); [print(f\"Found in: {dep.get('fileName', 'Unknown')}\") or [print(f\"  - {v.get('name', 'Unknown')}: {v.get('description', 'No description')[:100]}...\") for v in dep.get('vulnerabilities', [])[:2]] for dep in data.get('dependencies', []) if dep.get('vulnerabilities')][:1] if vulns > 0 else None"
          else
            echo "‚ùå JSON report not found"
          fi

      - name: Upload Security Reports
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: |
            reports/
          retention-days: 30
          if-no-files-found: warn

  security-checks:
    runs-on: ubuntu-latest
    needs: [sonarqube, dependency-check]
    steps:
      - name: Security Scan Summary
        run: |
          echo "========================================"
          echo "‚úÖ All security scans completed successfully!"
          echo "üìÅ Available reports:"
          echo "   - SonarQube (SAST) results: Check SonarCloud dashboard"
          echo "   - Dependency Check (SCA) reports: Download 'security-reports' artifact"
          echo "========================================"