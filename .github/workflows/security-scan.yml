name: Security Scan

on: [push, pull_request]

jobs:
  sonarqube:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: SonarQube Scan
        uses: SonarSource/sonarqube-scan-action@v4
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  dependency-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Cache Dependency Check Database
        uses: actions/cache@v3
        with:
          path: ~/.dependency-check/data
          key: dependency-check-db-${{ runner.os }}-${{ hashFiles('**/composer.lock', '**/package-lock.json') }}
          restore-keys: |
            dependency-check-db-${{ runner.os }}-

      - name: Download and Install OWASP Dependency Check
        run: |
          echo "üì¶ Downloading OWASP Dependency Check..."
          wget -q https://github.com/jeremylong/DependencyCheck/releases/download/v10.0.0/dependency-check-10.0.0-release.zip
          unzip -q dependency-check-10.0.0-release.zip -d dependency-check
          chmod +x dependency-check/dependency-check/bin/dependency-check.sh
          ./dependency-check/dependency-check/bin/dependency-check.sh --version

      - name: Configure Dependency Check (JSON Feeds Only)
        run: |
          echo "‚öôÔ∏è Configuring Dependency Check to use JSON feeds only (no API)"
          mkdir -p ~/.dependency-check
          # –û—Ç–∫–ª—é—á–∞–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ NVD API, –∑–∞—Å—Ç–∞–≤–ª—è–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ JSON feeds
          echo "data.nvd.validForHours=0" > ~/.dependency-check/dependency-check.properties
          echo "‚úÖ Configuration saved: will use JSON feeds instead of API"

      - name: Update Dependency Check Database
        continue-on-error: true
        timeout-minutes: 60
        run: |
          echo "üîÑ Updating Dependency Check database..."
          echo "Using JSON feeds only (no API key, slower but reliable)"
          echo "First run may take 30-60 minutes..."
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –≤ –∫—ç—à–µ
          DB_FILES=$(find ~/.dependency-check/data -type f 2>/dev/null | wc -l)
          if [ "$DB_FILES" -gt 50 ]; then
            echo "‚úÖ Using cached database ($DB_FILES files)"
            echo "Skipping update, will use --noupdate during scan"
          else
            echo "‚ö†Ô∏è No cached database found ($DB_FILES files)"
            echo "Updating database using JSON feeds (no API, no API key needed)..."
            echo "This will take 30-60 minutes on first run..."
            
            # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ë–ï–ó API - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç–æ–ª—å–∫–æ JSON feeds
            ./dependency-check/dependency-check/bin/dependency-check.sh --updateonly || {
              echo "‚ö†Ô∏è Database update had errors, but will continue with scan"
            }
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            NEW_FILES=$(find ~/.dependency-check/data -type f 2>/dev/null | wc -l)
            if [ "$NEW_FILES" -gt 50 ]; then
              echo "‚úÖ Database updated successfully ($NEW_FILES files)"
            else
              echo "‚ö†Ô∏è Database update incomplete ($NEW_FILES files), but will try scan anyway"
            fi
          fi

      - name: Run Dependency Check Scan
        continue-on-error: true
        timeout-minutes: 30
        run: |
          echo "üîç Starting Dependency Check scan..."
          mkdir -p reports
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
          DB_FILES=$(find ~/.dependency-check/data -type f 2>/dev/null | wc -l)
          if [ "$DB_FILES" -gt 50 ]; then
            echo "‚úÖ Database available ($DB_FILES files), using --noupdate"
            NOUPDATE_FLAG="--noupdate"
          else
            echo "‚ö†Ô∏è Database incomplete ($DB_FILES files), will attempt update during scan"
            NOUPDATE_FLAG=""
          fi
          
          # –ó–∞–ø—É—Å–∫–∞–µ–º —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
          ./dependency-check/dependency-check/bin/dependency-check.sh \
            --project "DVWA" \
            --scan ./app \
            --format HTML \
            --format JSON \
            --out ./reports \
            $NOUPDATE_FLAG \
            --enableExperimental \
            --failOnCVSS 11 || {
              echo "‚ö†Ô∏è Scan completed with warnings/errors"
              echo "This is normal if database is still updating"
            }
          
          echo "‚úÖ Scan process completed!"

      - name: Check Generated Reports
        run: |
          echo "üìä Checking generated reports..."
          if [ -f "reports/dependency-check-report.html" ]; then
            echo "‚úÖ HTML report generated: $(ls -lh reports/dependency-check-report.html)"
            echo "--- Report Summary ---"
            # –ò–∑–≤–ª–µ–∫–∞–µ–º –∫–ª—é—á–µ–≤—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–∑ HTML-–æ—Ç—á–µ—Ç–∞
            grep -i "vulnerabilities\|dependencies" reports/dependency-check-report.html | head -5
          else
            echo "‚ùå HTML report not found"
          fi
          
          if [ -f "reports/dependency-check-report.json" ]; then
            echo "‚úÖ JSON report generated: $(ls -lh reports/dependency-check-report.json)"
            echo "--- JSON Summary ---"
            # –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ JSON
            python3 -c "import json, os; data = json.load(open('reports/dependency-check-report.json')) if os.path.exists('reports/dependency-check-report.json') else {}; deps = len(data.get('dependencies', [])); vulns = sum(len(d.get('vulnerabilities', [])) for d in data.get('dependencies', [])); print(f'Scanned Dependencies: {deps}'); print(f'Total Vulnerabilities Found: {vulns}'); [print(f\"Found in: {dep.get('fileName', 'Unknown')}\") or [print(f\"  - {v.get('name', 'Unknown')}: {v.get('description', 'No description')[:100]}...\") for v in dep.get('vulnerabilities', [])[:2]] for dep in data.get('dependencies', []) if dep.get('vulnerabilities')][:1] if vulns > 0 else None"
          else
            echo "‚ùå JSON report not found"
          fi

      - name: Upload Security Reports
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: |
            reports/
          retention-days: 30
          if-no-files-found: warn

  security-checks:
    runs-on: ubuntu-latest
    needs: [sonarqube, dependency-check]
    steps:
      - name: Security Scan Summary
        run: |
          echo "========================================"
          echo "‚úÖ All security scans completed successfully!"
          echo "üìÅ Available reports:"
          echo "   - SonarQube (SAST) results: Check SonarCloud dashboard"
          echo "   - Dependency Check (SCA) reports: Download 'security-reports' artifact"
          echo "========================================"