# Вопрос профессору: Проблема с обновлением базы данных OWASP Dependency Check

## Проблема

При настройке OWASP Dependency Check для автоматического анализа зависимостей (SCA) в GitHub Actions возникла проблема с обновлением базы данных уязвимостей NVD (National Vulnerability Database).

**Суть проблемы:**
- Dependency Check не может обновить базу данных из-за ошибки: "Unable to obtain an exclusive lock on the H2 database to perform updates" и "Error updating the NVD Data; the NVD returned a 403 or 404 error"
- Проблема возникает как при локальном запуске, так и в GitHub Actions
- Ошибка возникает даже при наличии валидного NVD API ключа

## Методы решения, которые мы пробовали

### Метод 1: Использование NVD API ключа
**Что делали:**
- Получили бесплатный NVD API ключ с сайта nvd.nist.gov
- Настроили API ключ через:
  - Переменные окружения (`NVD_API_KEY`)
  - Параметр командной строки (`--nvdApiKey`)
  - Конфигурационный файл (`~/.dependency-check/dependency-check.properties`)

**Результат:** Не сработало. Dependency Check всё равно получал ошибку 403/404 при обращении к NVD API, даже с валидным ключом.

**Причина:** Известная проблема Dependency Check версии 9.0.9 с NVD API v2.0, особенно в CI окружениях.

---

### Метод 2: Использование JSON feeds вместо API
**Что делали:**
- Настроили конфигурацию `data.nvd.validForHours=0` для принудительного использования JSON feeds
- Увеличили задержки между запросами (`--nvdApiDelay 60000`)
- Увеличили количество попыток (`--nvdMaxRetryCount 10`)

**Результат:** Не сработало. Dependency Check всё равно пытался использовать API, игнорируя конфигурацию.

**Причина:** Dependency Check 9.0.9 имеет проблемы с чтением конфигурации для отключения API.

---

### Метод 3: Обновление базы данных в отдельном шаге
**Что делали:**
- Разделили процесс на два шага: обновление базы данных и сканирование
- Использовали отдельные Docker контейнеры для каждого шага
- Добавили кэширование базы данных между запусками

**Результат:** Не сработало. Возникла ошибка блокировки базы данных H2: "Unable to obtain an exclusive lock on the H2 database to perform updates".

**Причина:** База данных H2 требует эксклюзивной блокировки для обновления, и даже в отдельном контейнере возникают конфликты блокировок.

---

### Метод 4: Использование временной директории для обновления
**Что делали:**
- Обновляли базу данных во временной директории
- Затем копировали обновлённую базу в постоянную директорию
- Удаляли файлы блокировки перед обновлением

**Результат:** Не сработало. Та же ошибка блокировки, даже во временной директории.

**Причина:** Проблема не в конфликте с существующей базой, а в самом процессе обновления через NVD API.

---

### Метод 5: Использование Dependency Check 10.0.0
**Что делали:**
- Обновили Dependency Check до версии 10.0.0 (которая должна лучше работать с NVD API)
- Настроили workflow для использования версии 10.0.0

**Результат:** Частично сработало. Версия 10.0.0 лучше работает, но проблема с блокировкой базы данных остаётся.

**Причина:** Проблема блокировки связана с архитектурой H2 базы данных, а не только с версией Dependency Check.

---

### Метод 6: Сканирование без обновления базы данных
**Что делали:**
- Использовали параметр `--noupdate` для сканирования без обновления базы
- Настроили workflow для работы с пустой базой данных
- Добавили кэширование для сохранения базы между запусками

**Результат:** Работает, но с ограничениями. Отчёты генерируются, но не содержат данных об уязвимостях, так как база данных пустая.

**Причина:** Это обходное решение, которое позволяет инструменту работать, но без полной функциональности.

---

## Текущее состояние

**Что работает:**
- ✅ OWASP Dependency Check установлен и настроен
- ✅ Интеграция в GitHub Actions выполнена
- ✅ Workflow запускается без ошибок
- ✅ Отчёты генерируются (HTML и JSON форматы)
- ✅ Отчёты сохраняются в артефактах GitHub Actions

**Что не работает:**
- ❌ Обновление базы данных NVD (ошибка блокировки и 403/404)
- ❌ Отчёты не содержат данных об уязвимостях (база данных пустая)

---

## Вопрос

**Можно ли для финального проекта использовать текущее решение (сканирование без обновления базы данных)?**

**Обоснование:**
1. Инструмент полностью настроен и интегрирован в CI/CD pipeline
2. Все технические шаги выполнены корректно
3. Проблема с обновлением базы данных является известной проблемой Dependency Check 9.0.9 и NVD API
4. В отчёте можно описать:
   - Настройку и интеграцию инструмента
   - Проблему с обновлением базы данных и её причины
   - Решение (использование кэширования и сканирования без обновления)
   - Ограничения текущего решения

**Альтернативные варианты:**
- Использовать готовую базу данных из публичного источника (если доступна)
- Использовать альтернативный инструмент SCA (Snyk, GitHub Dependabot)
- Описать проблему и предложить решение для будущих улучшений

---

## Дополнительная информация

**Используемые версии:**
- OWASP Dependency Check: 9.0.9 и 10.0.0
- Java: OpenJDK 17
- GitHub Actions: Ubuntu latest
- Docker: официальный образ `owasp/dependency-check:latest`

**Ссылки на документацию проблемы:**
- https://github.com/jeremylong/DependencyCheck/issues (известные проблемы с NVD API)
- https://github.com/jeremylong/Open-Vulnerability-Project/tree/main/vulnz#api-key-is-used-and-a-403-or-404-error-occurs

---

**Спасибо за понимание и помощь в решении этой проблемы!**

