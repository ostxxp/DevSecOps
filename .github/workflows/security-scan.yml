name: SAST Scan

on: [push, pull_request]

jobs:
  sonarqube:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: SonarQube Scan
        uses: SonarSource/sonarqube-scan-action@v4
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  dependency-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install OWASP Dependency Check
        run: |
          # Try latest version first (10.0.0), fallback to 9.0.9 if not available
          wget https://github.com/jeremylong/DependencyCheck/releases/download/v10.0.0/dependency-check-10.0.0-release.zip || \
          wget https://github.com/jeremylong/DependencyCheck/releases/download/v9.0.9/dependency-check-9.0.9-release.zip
          unzip dependency-check-*-release.zip -d dependency-check
          chmod +x dependency-check/dependency-check/bin/dependency-check.sh

      - name: Debug - Check API Key
        env:
          NVD_API_KEY: ${{ secrets.NVD_API_KEY }}
        run: |
          # Check if secret exists in GitHub (even if empty)
          if [ -z "${{ secrets.NVD_API_KEY }}" ]; then
            echo "❌ ERROR: NVD_API_KEY secret does NOT exist in GitHub Secrets!"
            echo "Please add NVD_API_KEY to GitHub Secrets:"
            echo "1. Go to: Settings → Secrets and variables → Actions"
            echo "2. Click 'New repository secret'"
            echo "3. Name: NVD_API_KEY"
            echo "4. Value: e3efde5e-e313-4cd5-80dc-e8bb6ef73a60"
            exit 1
          fi
          
          # Check if secret is set in environment
          if [ -n "$NVD_API_KEY" ]; then
            echo "✅ NVD_API_KEY is set correctly"
            echo "Length: ${#NVD_API_KEY} characters"
            echo "First 10 chars: ${NVD_API_KEY:0:10}..."
            echo "Last 10 chars: ...${NVD_API_KEY: -10}"
            echo "Format check: $([ ${#NVD_API_KEY} -eq 36 ] && echo '✅ Correct length (36 chars)' || echo '⚠️ Unexpected length')"
          else
            echo "⚠️ WARNING: NVD_API_KEY secret exists but is empty!"
            echo "Please check the secret value in GitHub Settings"
          fi

      - name: Create Dependency Check Config
        env:
          NVD_API_KEY: ${{ secrets.NVD_API_KEY }}
        run: |
          if [ -n "$NVD_API_KEY" ]; then
            mkdir -p ~/.dependency-check
            echo "nvd.api.key=$NVD_API_KEY" > ~/.dependency-check/dependency-check.properties
            echo "✅ Created dependency-check.properties with API key"
          else
            echo "⚠️ NVD_API_KEY not available, config file not created"
          fi

      - name: Update Dependency Check Database
        continue-on-error: true
        env:
          NVD_API_KEY: ${{ secrets.NVD_API_KEY }}
        run: |
          if [ -n "$NVD_API_KEY" ]; then
            echo "Attempting database update with API key..."
            # Try with config file first
            ./dependency-check/dependency-check/bin/dependency-check.sh \
              --updateonly \
              --nvdApiDelay 30000 \
              --nvdMaxRetryCount 2 || {
                echo "Update with config file failed, trying with --nvdApiKey parameter"
                ./dependency-check/dependency-check/bin/dependency-check.sh \
                  --updateonly \
                  --nvdApiKey "$NVD_API_KEY" \
                  --nvdApiDelay 30000 \
                  --nvdMaxRetryCount 2 || {
                    echo "⚠️ Database update failed - this is a known issue with Dependency Check 9.0.9"
                    echo "Will continue with --skipUpdate for scanning"
                  }
              }
          else
            echo "Warning: NVD_API_KEY not available, skipping update"
          fi

      - name: Run Dependency Check (SCA)
        continue-on-error: true
        env:
          NVD_API_KEY: ${{ secrets.NVD_API_KEY }}
        run: |
          mkdir -p reports
          
          echo "Starting Dependency Check scan..."
          echo "Note: Due to known issues with Dependency Check 9.0.9 and NVD API,"
          echo "we will use --skipUpdate to work with existing database if update fails."
          
          # Since database update likely failed, use --skipUpdate to work with existing DB
          # This allows the tool to run and generate reports even if update doesn't work
          if [ -n "$NVD_API_KEY" ]; then
            echo "Running scan with API key (skipping update due to NVD API issues)..."
            ./dependency-check/dependency-check/bin/dependency-check.sh \
              --project "DVWA" \
              --scan ./app \
              --format JSON \
              --format HTML \
              --out ./reports \
              --nvdApiKey "$NVD_API_KEY" \
              --skipUpdate \
              --enableExperimental \
              --failOnCVSS 11 || {
                echo "Scan with API key failed, trying without API key"
                ./dependency-check/dependency-check/bin/dependency-check.sh \
                  --project "DVWA" \
                  --scan ./app \
                  --format JSON \
                  --format HTML \
                  --out ./reports \
                  --skipUpdate \
                  --enableExperimental \
                  --failOnCVSS 11 || true
              }
          else
            echo "Running scan without API key (skipping update)..."
            ./dependency-check/dependency-check/bin/dependency-check.sh \
              --project "DVWA" \
              --scan ./app \
              --format JSON \
              --format HTML \
              --out ./reports \
              --skipUpdate \
              --enableExperimental \
              --failOnCVSS 11 || true
          fi
          
          # Check if reports were generated
          if [ -f reports/dependency-check-report.html ] || [ -f reports/dependency-check-report.json ]; then
            echo "Reports generated successfully"
            ls -lh reports/
          else
            echo "Warning: No reports generated"
          fi

      - name: Upload Reports Artifact
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: reports/
          retention-days: 30
