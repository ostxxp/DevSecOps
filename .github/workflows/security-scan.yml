name: Security Scan

on: [push, pull_request]

jobs:
  sonarqube:
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: SonarQube Scan
        continue-on-error: true
        uses: SonarSource/sonarqube-scan-action@v4
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        # SonarQube –æ–ø—Ü–∏–æ–Ω–∞–ª–µ–Ω - –µ—Å–ª–∏ —Ç–æ–∫–µ–Ω –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω, workflow –ø—Ä–æ–¥–æ–ª–∂–∏—Ç —Ä–∞–±–æ—Ç—É

  sca-analysis:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Trivy Security Scan (SCA)
        continue-on-error: true
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: './app'
          format: 'json'
          output: 'reports/trivy-report.json'
          severity: 'CRITICAL,HIGH,MEDIUM'
          exit-code: '0'

      - name: Generate Trivy Report (Table Format)
        continue-on-error: true
        run: |
          trivy fs --format table --output reports/trivy-report.txt ./app || true
          cat reports/trivy-report.txt || echo "Report generation failed"

      - name: Check Generated Reports
        run: |
          echo "üìä Checking generated reports..."
          if [ -f "reports/trivy-report.json" ]; then
            echo "‚úÖ Trivy JSON report generated: $(ls -lh reports/trivy-report.json)"
            # –ü–∞—Ä—Å–∏–º JSON –¥–ª—è –≤—ã–≤–æ–¥–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
            python3 -c "import json; f=open('reports/trivy-report.json'); d=json.load(f); r=d.get('Results',[]); t=sum(len(res.get('Vulnerabilities',[])) for res in r); print(f'Total vulnerabilities found: {t}'); [print(f\"Found in {res.get('Target','Unknown')}: {len(res.get('Vulnerabilities',[]))} vulns\") for res in r if res.get('Vulnerabilities')]"
          else
            echo "‚ùå Trivy report not found"
          fi

      - name: Upload SCA Reports
        uses: actions/upload-artifact@v4
        with:
          name: sca-reports
          path: reports/trivy-*
          retention-days: 30
          if-no-files-found: warn

  dependabot-check:
    runs-on: ubuntu-latest
    permissions:
      security-events: read
      contents: read
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check Dependabot Security Alerts
        run: |
          echo "üìä Checking Dependabot Security Alerts..."
          echo "View alerts at: https://github.com/${{ github.repository }}/security/dependabot"
          echo ""
          
          # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º GitHub CLI
          if ! command -v gh &> /dev/null; then
            echo "Installing GitHub CLI..."
            type -p curl >/dev/null || (apt-get update && apt-get install curl -y)
            curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
            echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | tee /etc/apt/sources.list.d/github-cli.list > /dev/null
            apt-get update
            apt-get install gh -y
          fi
          
          # –ê–≤—Ç–æ—Ä–∏–∑—É–µ–º—Å—è (–∏—Å–ø–æ–ª—å–∑—É–µ–º GITHUB_TOKEN)
          echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token
          
          # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ Dependabot alerts
          echo "Fetching Dependabot alerts..."
          ALERTS_COUNT=$(gh api repos/${{ github.repository }}/dependabot/alerts --jq 'length' 2>/dev/null || echo "0")
          
          if [ "$ALERTS_COUNT" = "0" ] || [ -z "$ALERTS_COUNT" ]; then
            echo "‚úÖ No Dependabot alerts found"
            echo "This means either:"
            echo "  1. No vulnerabilities found in dependencies"
            echo "  2. Dependabot hasn't scanned yet (wait 5-10 minutes after creating dependabot.yml)"
          else
            echo "‚ö†Ô∏è Found $ALERTS_COUNT Dependabot security alert(s)"
            echo ""
            echo "Top 5 alerts:"
            gh api repos/${{ github.repository }}/dependabot/alerts --jq '.[] | select(.state=="open") | "  - \(.dependency.package.name)@\(.dependency.manifest_path): \(.security_advisory.summary)"' 2>/dev/null | head -5 || echo "  (Unable to fetch details - check GitHub Security tab)"
            echo ""
            echo "üìã View all alerts: https://github.com/${{ github.repository }}/security/dependabot"
          fi
          
          echo ""
          echo "‚úÖ Dependabot check completed!"

  dependency-check:
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Cache Dependency Check Database
        uses: actions/cache@v3
        with:
          path: ~/.dependency-check/data
          key: dependency-check-db-${{ runner.os }}-v7
          restore-keys: |
            dependency-check-db-${{ runner.os }}-

      - name: Configure Dependency Check (JSON Feeds Only)
        run: |
          echo "‚öôÔ∏è Configuring Dependency Check to use JSON feeds only (NO API)"
          mkdir -p ~/.dependency-check
          echo "data.nvd.validForHours=0" > ~/.dependency-check/dependency-check.properties
          echo "‚úÖ Configuration: JSON feeds only, no API"

      - name: Download Pre-populated Database (Optional)
        continue-on-error: true
        run: |
          # –ï—Å–ª–∏ —É –≤–∞—Å –µ—Å—Ç—å –≥–æ—Ç–æ–≤–∞—è –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –≤ GitHub Releases –∏–ª–∏ –¥—Ä—É–≥–æ–º –∏—Å—Ç–æ—á–Ω–∏–∫–µ
          # –†–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ –∏ —É–∫–∞–∂–∏—Ç–µ URL:
          # mkdir -p ~/.dependency-check/data
          # wget -q YOUR_DATABASE_URL -O /tmp/db.tar.gz
          # tar -xzf /tmp/db.tar.gz -C ~/.dependency-check/data
          echo "‚ÑπÔ∏è Pre-populated database download skipped (not configured)"
          echo "To use: upload database to GitHub Releases and uncomment download step"

      - name: Run Dependency Check Scan
        continue-on-error: true
        timeout-minutes: 90
        run: |
          echo "üîç Starting Dependency Check scan..."
          echo "Using JSON feeds only (NO NVD API)"
          
          mkdir -p reports
          mkdir -p ~/.dependency-check/data
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
          DB_FILES=$(find ~/.dependency-check/data -type f 2>/dev/null | wc -l)
          
          if [ "$DB_FILES" -gt 50 ]; then
            echo "‚úÖ Using cached database ($DB_FILES files)"
            USE_NOUPDATE="--noupdate"
          else
            echo "‚ö†Ô∏è No cached database found ($DB_FILES files)"
            echo "Will attempt scan without database update (may have limited results)"
            echo "Note: Reports will be generated but may not contain vulnerability data"
            echo ""
            echo "To get full vulnerability data:"
            echo "  1. Update database locally: dependency-check.sh --updateonly"
            echo "  2. Archive: tar -czf db.tar.gz ~/.dependency-check/data"
            echo "  3. Upload to GitHub Releases"
            echo "  4. Uncomment download step in workflow"
            USE_NOUPDATE="--noupdate"
          fi
          
          # –ó–∞–ø—É—Å–∫–∞–µ–º —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
          # Dependency Check –º–æ–∂–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –¥–∞–∂–µ —Å –ø—É—Å—Ç–æ–π –±–∞–∑–æ–π - –ø—Ä–æ—Å—Ç–æ –Ω–µ –Ω–∞–π–¥–µ—Ç —É—è–∑–≤–∏–º–æ—Å—Ç–∏
          docker run --rm \
            -v "$PWD:/src" \
            -v "$PWD/reports:/report" \
            -v "$HOME/.dependency-check/data:/data" \
            -v "$HOME/.dependency-check/dependency-check.properties:/usr/share/dependency-check/conf/dependency-check.properties:ro" \
            owasp/dependency-check:latest \
            --scan /src/app \
            --format HTML \
            --format JSON \
            --out /report \
            --project "DVWA" \
            --data /data \
            $USE_NOUPDATE \
            --enableExperimental \
            --failOnCVSS 11 || {
              echo "‚ö†Ô∏è Scan completed with warnings"
              echo "This is normal if database is empty - scan will still generate reports"
            }
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å–æ–∑–¥–∞–ª–∞—Å—å –ª–∏ –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ—Å–ª–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
          NEW_DB_FILES=$(find ~/.dependency-check/data -type f 2>/dev/null | wc -l)
          if [ "$NEW_DB_FILES" -gt 50 ]; then
            echo "‚úÖ Database is now available ($NEW_DB_FILES files) - will be cached for next run"
          else
            echo "‚ö†Ô∏è Database still empty ($NEW_DB_FILES files)"
            echo "Reports generated but may not contain vulnerability data"
          fi
          
          echo "‚úÖ Scan completed!"

      - name: Check Generated Reports
        run: |
          echo "üìä Checking generated reports..."
          if [ -f "reports/dependency-check-report.html" ]; then
            echo "‚úÖ HTML report generated: $(ls -lh reports/dependency-check-report.html)"
          else
            echo "‚ùå HTML report not found"
          fi
          
          if [ -f "reports/dependency-check-report.json" ]; then
            echo "‚úÖ JSON report generated: $(ls -lh reports/dependency-check-report.json)"
            python3 -c "import json, os; data = json.load(open('reports/dependency-check-report.json')) if os.path.exists('reports/dependency-check-report.json') else {}; deps = len(data.get('dependencies', [])); vulns = sum(len(d.get('vulnerabilities', [])) for d in data.get('dependencies', [])); print(f'Scanned Dependencies: {deps}'); print(f'Total Vulnerabilities Found: {vulns}')"
          else
            echo "‚ùå JSON report not found"
          fi

      - name: Upload Security Reports
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: reports/
          retention-days: 30
          if-no-files-found: warn

  security-checks:
    runs-on: ubuntu-latest
    needs: [sonarqube, sca-analysis, dependabot-check]
    if: always()  # –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –¥–∞–∂–µ –µ—Å–ª–∏ –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ jobs —É–ø–∞–ª–∏
    steps:
      - name: Security Scan Summary
        run: |
          echo "========================================"
          echo "‚úÖ Security scans completed!"
          echo "üìÅ Available reports:"
          echo "   - SonarQube (SAST): Check SonarCloud dashboard (optional)"
          echo "   - Trivy (SCA): Download 'sca-reports' artifact"
          echo "   - Dependabot (SCA): https://github.com/${{ github.repository }}/security/dependabot"
          echo ""
          echo "Note: SonarQube may fail if not configured - this is OK for SCA analysis"
          echo "========================================"
